const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const rimraf = require('rimraf');
const cpy = require('cpy');

function root(...segments) {
  return path.join(__dirname, '..', ...segments);
}

module.exports = async function createReactProject(options) {
  // Prevent writing to non-empty directory.
  if (fs.existsSync(options.out)) {
    throw new Error(`Cannot write files to non-empty directory ${path.resolve(options.out)}`);
  }

  // Copy template files sto output directory.
  for (const dir of [".vscode", "babel", "pages", "public", "scripts", "src", "typings"]) {
    // "-R" copy whole directory subtree
    // "-P" don't allow symbolic links
    execSync(`cp -R -P ${root(`template/${dir}`)} ${options.out}`, {stdio: 'inherit'});
  }

  // Copy files from template dir.
  await cpy([
    root('template/*'), root('template/.*')], options.out, {
    // Make sure we will copy top-level files only.
      expandDirectories: false,
      // Ignore paths specified in gitignore.
    gitignore: true,
  });

  const pkg = require("./template/package.json");

  // Set correct project name in package.json
  pkg.name = options.name;

  fs.writeFileSync(path.join(options.out, 'package.json'), JSON.stringify(pkg, null, 2), 'utf-8')

  // Remove yarn.lock.
  // It will be regenerated by yarn when installing.
  rimraf.sync(path.join(options.out, 'yarn.lock'));

  if (!Boolean(process.env.SKIP_SCRIPTS)) {
    execSync(`(cd ${options.out} && yarn && yarn lint --fix && yarn typecheck)`, {
      stdio: 'inherit'
    });
  }
}
